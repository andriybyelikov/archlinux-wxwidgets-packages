# Mantainer: Andriy Byelikov <andriybyelikov@gmail.com>

pkgbase=wxgtk-git
pkgname=(libwxbase-git libwxgtk2-git libwxgtk3-git wx-i18n-git
         wxgtk2-config-git wxgtk3-config-git wx-headers-git wx-utils-git)
pkgver=3.1.5
pkgrel=1
arch=('x86_64')
url="https://wxwidgets.org"
license=('custom:wxWindows')
options=('!emptydirs')
source=("git+https://github.com/wxWidgets/wxWidgets.git"
        "make-abicheck-non-fatal.patch")
sha256sums=('SKIP'
            '46a1bb97d69163547da13d5e23a4c73e68de27ee601da5d2fb5bc5c417931453')

prepare() {
  cd wxWidgets
  git submodule update --init 3rdparty/catch
  patch -Np1 -i ../make-abicheck-non-fatal.patch
}

_build_gtk() {
  mkdir -p gtk$1-build
  cd gtk$1-build
  ../configure --prefix=/usr --with-opengl --enable-graphics_ctx \
    --enable-mediactrl --with-regex=builtin --disable-precomp-headers \
    --with-libpng=sys --with-libxpm=sys --with-libjpeg=sys --with-libtiff=sys \
    --with-gtk=$@
  make
}

build() {
  cd wxWidgets
  make -C locale allmo
  _build_gtk 2
  _build_gtk 3 --enable-webview
}

# Runtime packages

package_wx-i18n-git() {
  pkgdesc="wxWidgets gettext catalogs"
  arch=('any')

  cd wxWidgets/gtk2-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,include,lib,share/{aclocal,bakefile}}

  install -Dm644 ../docs/licence.txt "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/lib/libwx_base*
package_libwxbase-git() {
  pkgdesc="wxWidgets"

  cd wxWidgets/gtk3-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,include,lib/{wx,libwx_gtk*},share}

  install -Dm644 ../docs/licence.txt "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/lib/libwx_gtk*
package_libwxgtk2-git() {
  pkgdesc=""
  depends=(libwxbase)

  cd wxWidgets/gtk2-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,include,lib/{wx/{config,include},libwx_base*},share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-git/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/lib/libwx_gtk*
package_libwxgtk3-git() {
  pkgdesc=""
  depends=(libwxbase)

  cd wxWidgets/gtk3-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,include,lib/{wx/{config,include},libwx_base*},share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-git/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# Development packages

# /usr/lib/wx/{config,include}
package_wxgtk2-config-git() {
  pkgdesc=""
  arch=('any')
  depends=(libwxbase libwxgtk2)

  cd wxWidgets/gtk2-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin/wxrc*,include,lib/libwx_*,share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-git/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/lib/wx/{config,include}
package_wxgtk3-config-git() {
  pkgdesc=""
  arch=('any')
  depends=(libwxbase libwxgtk3)

  cd wxWidgets/gtk3-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin/wxrc*,include,lib/libwx_*,share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-git/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/include
package_wx-headers-git() {
  pkgdesc=""
  arch=('any')
  depends=(libwxbase)

  cd wxWidgets/gtk2-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,lib,share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-git/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/share/aclocal
# /usr/share/bakefile
package_wx-utils-git() {
  pkgdesc=""
  depends=(libwxbase)

  cd wxWidgets
  cd utils-build
  make DESTDIR="$pkgdir" install-wxrc
  rm "$pkgdir"/usr/bin/wxrc
  mv "$pkgdir"/usr/bin/wxrc-3.1 "$pkgdir"/usr/bin/wxrc
  install -Dm644 ../wxwin.m4 "$pkgdir"/usr/share/aclocal/wxwin.m4
  mkdir -p "$pkgdir"/usr/share/bakefile/presets
  cp -r ../build/bakefiles/wxpresets/presets "$pkgdir"/usr/share/bakefile

  install -Dm644 ../docs/licence.txt "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/bin/wxrc
package_wxrc-git() {
  pkgdesc=""
}

# /usr/bin/wx-config
