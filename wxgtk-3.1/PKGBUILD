# Mantainer: Andriy Byelikov <andriybyelikov@gmail.com>

pkgbase=wxgtk-3.1
pkgname=(libwxbase-3.1 libwxgtk2-3.1 libwxgtk3-3.1 wx-i18n-3.1
         wxgtk2-config-3.1 wxgtk3-config-3.1 wx-headers-3.1)
pkgver=3.1.4
pkgrel=1
pkgdesc=""
arch=('x86_64')
url="https://wxwidgets.org"
license=('custom:wxWindows')
options=('!emptydirs')
source=("https://github.com/wxWidgets/wxWidgets/releases/download/v$pkgver/wxWidgets-$pkgver.tar.bz2"
        "make-abicheck-non-fatal.patch" "i18n-version-suffix.patch")
sha256sums=('3ca3a19a14b407d0cdda507a7930c2e84ae1c8e74f946e0144d2fa7d881f1a94'
            '46a1bb97d69163547da13d5e23a4c73e68de27ee601da5d2fb5bc5c417931453'
            'c3780dedd790ab7a201588a76aa011d1a5add614d411b065ff72f383b4c1be43')

prepare() {
  cd wxWidgets-$pkgver
  patch -Np1 -i ../make-abicheck-non-fatal.patch
  patch -Np1 -i ../i18n-version-suffix.patch
}

build() {
  cd wxWidgets-$pkgver

  make -C locale allmo

  mkdir -p gtk2-build
  cd gtk2-build
  ../configure --prefix=/usr --with-opengl --enable-graphics_ctx \
    --enable-mediactrl --with-regex=builtin --disable-precomp-headers \
    --with-libpng=sys --with-libxpm=sys --with-libjpeg=sys --with-libtiff=sys \
    --with-gtk=2
  make

  cd ..

  mkdir -p gtk3-build
  cd gtk3-build
  ../configure --prefix=/usr --with-opengl --enable-graphics_ctx \
    --enable-mediactrl --with-regex=builtin --disable-precomp-headers \
    --with-libpng=sys --with-libxpm=sys --with-libjpeg=sys --with-libtiff=sys \
    --with-gtk=3 --enable-webview
  make
}

# runtime packages

# /usr/lib/libwx_base*
package_libwxbase-3.1() {
  pkgdesc=""

  cd wxWidgets-$pkgver/gtk2-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,include,lib/{wx,libwx_gtk*},share}

  install -Dm644 ../docs/licence.txt "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/lib/libwx_gtk*
package_libwxgtk2-3.1() {
  pkgdesc=""
  depends=(libwxbase)

  cd wxWidgets-$pkgver/gtk2-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,include,lib/{wx/{config,include},libwx_base*},share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-3.1/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/lib/libwx_gtk*
package_libwxgtk3-3.1() {
  pkgdesc=""
  depends=(libwxbase)

  cd wxWidgets-$pkgver/gtk3-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,include,lib/{wx/{config,include},libwx_base*},share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-3.1/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/share/locale
package_wx-i18n-3.1() {
  pkgdesc=""
  depends=(libwxbase)

  cd wxWidgets-$pkgver/gtk2-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,include,lib,share/{aclocal,bakefile}}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-3.1/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}


# development packages

# /usr/lib/wx/{config,include}
package_wxgtk2-config-3.1() {
  pkgdesc=""
  depends=(libwxbase libwxgtk2)

  cd wxWidgets-$pkgver/gtk2-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin/{wxrc*},include,lib/libwx_*,share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-3.1/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/lib/wx/{config,include}
package_wxgtk3-config-3.1() {
  pkgdesc=""
  depends=(libwxbase libwxgtk3)

  cd wxWidgets-$pkgver/gtk3-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin/{wxrc*},include,lib/{libwx_*,wx/3.1.4},share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-3.1/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# /usr/include
package_wx-headers-3.1() {
  pkgdesc=""
  depends=(libwxbase)

  cd wxWidgets-$pkgver/gtk2-build
  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir"/usr/{bin,lib,share}

  mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
  ln -s /usr/share/licenses/libwxbase-3.1/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}
